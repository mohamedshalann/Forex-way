<!doctype html>
<html lang="ar">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SmartRisk.AI — Forex (Live + PayPal)</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
  body{font-family:system-ui,Arial;background:#071020;color:#e6eef8;margin:0;padding:16px}
  .card{background:#0b1220;padding:12px;border-radius:10px;margin-bottom:12px;box-shadow:0 8px 24px rgba(2,6,23,0.6)}
  header{display:flex;align-items:center;justify-content:space-between;gap:10px}
  select,input,button{padding:8px;border-radius:8px;border:1px solid #243142;background:#071126;color:#e6eef8}
  #chartWrapper{height:300px}
  .signal{font-weight:700;padding:6px 10px;border-radius:8px;display:inline-block}
  .buy{background:#063b13;color:#a7f3d0;border:1px solid #0b7a3a}
  .sell{background:#4b0505;color:#ffd7d7;border:1px solid #7a1212}
  .hold{background:#2b2f3a;color:#cbd5e1;border:1px solid #3b4250}
  .muted{color:#98a0b3;font-size:13px}
  .cta{display:inline-block;background:linear-gradient(90deg,#0070ba,#005ea6);color:#fff;padding:12px 18px;border-radius:10px;text-decoration:none;font-weight:700}
  .paynote{font-size:13px;color:#cfe6ff;margin-top:8px}
  .center{display:flex;gap:8px;align-items:center}
  .status{font-size:13px;color:#9fb0d6;margin-left:8px}
</style>
</head>
<body>
  <div class="card">
    <header>
      <div>
        <h2 style="margin:0">SmartRisk.AI — Forex (Live)</h2>
        <div class="muted">مصدر السعر: Frankfurter → fallback exchangerate.host</div>
      </div>
      <div class="center">
        <label>زوج:
          <select id="pair" style="margin-left:8px">
            <option>EUR/USD</option>
            <option>GBP/USD</option>
            <option>USD/JPY</option>
            <option>AUD/USD</option>
            <option>USD/EGP</option>
          </select>
        </label>
        <button id="startBtn">ابدأ</button>
        <button id="stopBtn" disabled>أوقف</button>
      </div>
    </header>
  </div>

  <div class="card">
    <div style="display:flex;gap:12px;align-items:center;margin-bottom:8px">
      <div>آخر سعر: <strong id="lastPrice">—</strong></div>
      <div>إشارة: <span id="signal" class="signal hold">HOLD</span></div>
      <div class="status" id="fetchStatus">جاهز</div>
      <div style="margin-left:auto">
        <span class="muted">احتمال نجاح: </span><strong id="prob">—</strong>%
      </div>
    </div>

    <div id="chartWrapper"><canvas id="chart"></canvas></div>

    <div style="margin-top:12px;display:flex;gap:12px;align-items:center">
      <!-- Primary CTA — Pay via PayPal redirect to your email -->
      <form id="paypalForm" action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_blank" style="margin:0">
        <input type="hidden" name="cmd" value="_xclick">
        <input type="hidden" name="business" value="mohamedgabershalan@gmail.com">
        <input type="hidden" name="item_name" value="SmartRisk Pro - 0.10 USD">
        <input type="hidden" name="amount" value="0.10">
        <input type="hidden" name="currency_code" value="USD">
        <!-- return to site after payment -->
        <input type="hidden" name="return" value="" id="paypalReturn">
        <input type="hidden" name="cancel_return" value="" id="paypalCancel">
        <button id="payBtn" class="cta" type="submit">ادفع 0.10$ لتفعيل Pro الآن</button>
      </form>

      <!-- Quick alternative link (only one visible to avoid confusion) -->
      <a id="paylink" class="cta" style="display:none" href="#" target="_blank" rel="noopener">ادفع الآن</a>

      <div style="margin-left:auto">
        <button id="iPaidBtn" style="padding:8px 10px;border-radius:8px;border:1px solid #2b3b4a;background:#0b1a28;color:#cfe6ff;cursor:pointer">لقد دفعت — حدثني</button>
        <div class="paynote" id="payNote">الدفع يفتح في تبويب PayPal. بعد الدفع ستعود لتفعيل يدوي عبر "لقد دفعت" (أو اطلب تفعيل تلقائي لاحقًا).</div>
      </div>
    </div>
  </div>

<script>
/* ========== إعداد الرسم ========== */
const ctx = document.getElementById('chart').getContext('2d');
let chart = new Chart(ctx, {
  type:'line',
  data: { labels:[], datasets:[
    { label:'السعر', data:[], borderColor:'#6ee7b7', borderWidth:2, tension:0.25, pointRadius:0 }
  ]},
  options:{responsive:true,maintainAspectRatio:false,scales:{x:{display:false}}}
});

/* ========== State ========== */
const POLL_MS = 8000;
const MAX_POINTS = 500;
const STORAGE_KEY = 'forexpulse_series_v_final';
let intervalId = null;

/* ========== Helpers: fetch with fallback ========== */
async function fetchFrankfurter(base, quote) {
  try {
    const url = `https://api.frankfurter.app/latest?from=${encodeURIComponent(base)}&to=${encodeURIComponent(quote)}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error('Frankfurter HTTP ' + res.status);
    const j = await res.json();
    if (j.rates && j.rates[quote]) return j.rates[quote];
    return null;
  } catch (e) { console.warn('frankfurter fail', e); return null; }
}

async function fetchExchangerate(base, quote) {
  try {
    const url = `https://api.exchangerate.host/latest?base=${encodeURIComponent(base)}&symbols=${encodeURIComponent(quote)}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error('exchangerate HTTP ' + res.status);
    const j = await res.json();
    if (j.rates && j.rates[quote]) return j.rates[quote];
    return null;
  } catch (e) { console.warn('exchangerate fail', e); return null; }
}

async function fetchLatest(pair) {
  const [base,quote] = pair.split('/');
  // Try Frankfurter first
  let price = await fetchFrankfurter(base, quote);
  if (price != null) {
    return {price};
  }
  // fallback
  price = await fetchExchangerate(base, quote);
  if (price != null) {
    return {price};
  }
  // both failed
  return null;
}

/* ========== Series storage ========== */
function loadSeries(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'); }catch(e){return []} }
function saveSeries(s){ localStorage.setItem(STORAGE_KEY, JSON.stringify(s.slice(-MAX_POINTS))); }

/* ========== Simple indicators (for signal) ========== */
function ema(arr, period) {
  if (!arr.length) return null;
  const k = 2/(period+1);
  let prev = arr[0];
  for (let i=1;i<arr.length;i++) prev = arr[i]*k + prev*(1-k);
  return prev;
}
function decideSimple(series) {
  const prices = series.map(p=>p.price);
  if (prices.length < 30) return {signal:'HOLD', score:null, reason:'حاجة لبيانات أكثر'};
  const e9 = ema(prices.slice(-50),9), e21 = ema(prices.slice(-50),21);
  if (e9==null || e21==null) return {signal:'HOLD', score:null, reason:'EMA غير متوفرة'};
  const score = Math.round(50 + ( (e9 - e21) / Math.max(0.0001, Math.abs(e21)) ) * 500); // heuristic
  return { signal: score >= 55 ? 'BUY' : score <=45 ? 'SELL' : 'HOLD', score: Math.max(0, Math.min(100, score)), reason:`EMA9=${e9.toFixed(6)} EMA21=${e21.toFixed(6)}`};
}

/* ========== Main tick ========== */
async function tick(pair) {
  document.getElementById('fetchStatus').textContent = 'جلب السعر...';
  const res = await fetchLatest(pair);
  if (!res) {
    document.getElementById('fetchStatus').textContent = 'فشل جلب السعر — جاري إعادة المحاولة...';
    return;
  }
  document.getElementById('fetchStatus').textContent = 'تم التحديث';
  const series = loadSeries();
  series.push({t:Date.now(), price: res.price});
  saveSeries(series);

  // update chart
  chart.data.labels = series.map(s=> new Date(s.t).toLocaleTimeString());
  chart.data.datasets[0].data = series.map(s=>s.price);
  chart.update();

  // update UI
  document.getElementById('lastPrice').textContent = res.price.toFixed(6);
  const decision = decideSimple(series);
  document.getElementById('prob').textContent = decision.score !== null ? decision.score : '—';
  const sEl = document.getElementById('signal');
  sEl.className = 'signal ' + (decision.signal==='BUY'?'buy':decision.signal==='SELL'?'sell':'hold');
  sEl.textContent = decision.signal;
  document.getElementById('fetchStatus').textContent = decision.reason || 'جاهز';
}

/* ========== Controls ========== */
document.getElementById('startBtn').addEventListener('click', async ()=>{
  const pair = document.getElementById('pair').value;
  document.getElementById('startBtn').disabled = true;
  document.getElementById('stopBtn').disabled = false;
  localStorage.removeItem(STORAGE_KEY);
  // set return URL after PayPal to current page with param
  const baseReturn = window.location.href.split('#')[0].split('?')[0];
  document.getElementById('paypalReturn').value = baseReturn + '?paid=1';
  document.getElementById('paypalCancel').value = baseReturn + '?paid=0';
  await tick(pair);
  intervalId = setInterval(()=> tick(pair), POLL_MS);
});

document.getElementById('stopBtn').addEventListener('click', ()=>{
  if (intervalId) clearInterval(intervalId);
  intervalId = null;
  document.getElementById('startBtn').disabled = false;
  document.getElementById('stopBtn').disabled = true;
});

/* ========== 'I paid' button (manual trigger) ========== */
document.getElementById('iPaidBtn').addEventListener('click', ()=>{
  // simple local activation (not secure) — you said you don't want to follow payments
  localStorage.setItem('smartrisk_pro_paid_manual','1');
  alert('تم تسجيل الدفع محليًا (اختبار). لاحقًا يمكنك استخدام تحقق خادم للتفعيل الآمن.');
  // optionally enable pro features here
});

/* ========== Init existing series if any ========= */
(function init(){
  const existing = loadSeries();
  if (existing.length){
    chart.data.labels = existing.map(s=> new Date(s.t).toLocaleTimeString());
    chart.data.datasets[0].data = existing.map(s=>s.price);
    chart.update();
  }
  // if URL contains ?paid=1 show thank you
  const params = new URLSearchParams(window.location.search);
  if (params.get('paid') === '1') {
    alert('شكراً للدفع! إذا أردت تفعيل Pro داخل الموقع استخدم زر "لقد دفعت".');
  }
})();
</script>
</body>
</html>

    <!doctype html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SmartRisk.AI â€” Forex Hybrid (Tech + News + Sentiment + Risk)</title>
<meta name="description" content="Prototype: Technical indicators + Economic calendar + News sentiment + Risk sizing. Client-side (works on GitHub Pages)" />
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
  body{font-family:system-ui,Arial; background:#071020;color:#e6eef8;margin:0;padding:16px}
  .card{background:#0b1220;padding:12px;border-radius:10px;margin-bottom:12px;box-shadow:0 8px 24px rgba(2,6,23,0.6)}
  header{display:flex;align-items:center;justify-content:space-between;gap:10px}
  select,input,button{padding:8px;border-radius:8px;border:1px solid #243142;background:#071126;color:#e6eef8}
  #chartWrapper{height:320px}
  .signal{font-weight:700;padding:6px 10px;border-radius:8px;display:inline-block}
  .buy{background:#063b13;color:#a7f3d0;border:1px solid #0b7a3a}
  .sell{background:#4b0505;color:#ffd7d7;border:1px solid #7a1212}
  .hold{background:#2b2f3a;color:#cbd5e1;border:1px solid #3b4250}
  .muted{color:#98a0b3;font-size:13px}
  .row{display:flex;gap:8px;align-items:center}
  .box{background:#071126;padding:10px;border-radius:8px;border:1px solid #182233}
  ul{margin:0;padding-left:16px}
  .newsItem{padding:6px 0;border-bottom:1px dashed rgba(255,255,255,0.03)}
  .impactHigh{color:#ffb4b4}
  .impactMed{color:#ffd7a8}
  .impactLow{color:#b7f5d2}
  small{color:#98a0b3}
  a.paylink{display:inline-block;background:#0070ba;color:white;padding:10px 14px;border-radius:8px;text-decoration:none}
  form.payform input[type="submit"]{background:#0070ba;color:white;border:0;padding:10px 14px;border-radius:8px;cursor:pointer}
</style>
</head>
<body>
  <div class="card">
    <header>
      <div>
        <h2 style="margin:0">SmartRisk.AI â€” Forex Hybrid Prototype</h2>
        <div class="muted">ØªÙ‚Ù†ÙŠ + ØªÙ‚ÙˆÙŠÙ… Ø§Ù‚ØªØµØ§Ø¯ÙŠ + Ù…Ø¹Ù†ÙˆÙŠØ§Øª Ø§Ù„Ø£Ø®Ø¨Ø§Ø± + Ø¥Ø¯Ø§Ø±Ø© Ù…Ø®Ø§Ø·Ø± â€” ÙŠØ¹Ù…Ù„ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¹Ù„Ù‰ GitHub Pages</div>
      </div>
      <div class="row">
        <label>Ø²ÙˆØ¬:
          <select id="pair">
            <option>EUR/USD</option>
            <option>GBP/USD</option>
            <option>USD/JPY</option>
            <option>AUD/USD</option>
            <option>USD/EGP</option>
          </select>
        </label>
        <button id="startBtn">Ø§Ø¨Ø¯Ø£</button>
        <button id="stopBtn" disabled>Ø£ÙˆÙ‚Ù</button>
      </div>
    </header>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between;align-items:flex-start">
      <div style="flex:1;margin-right:12px">
        <div style="display:flex;gap:12px;align-items:center;margin-bottom:8px">
          <div>Ø¢Ø®Ø± Ø³Ø¹Ø±: <strong id="lastPrice">â€”</strong></div>
          <div>Ø¥Ø´Ø§Ø±Ø©: <span id="signal" class="signal hold">HOLD</span></div>
          <div class="box">Ø§Ø­ØªÙ…Ø§Ù„ Ù†Ø¬Ø§Ø­: <strong id="prob">â€”</strong>%</div>
          <div style="margin-left:auto" class="muted" id="status">Ø¬Ø§Ù‡Ø²</div>
        </div>

        <div id="chartWrapper"><canvas id="chart"></canvas></div>

        <div style="margin-top:8px" class="muted">ØªÙ†Ø¨ÙŠÙ‡: Ø£Ø¯Ø§Ø© ØªØ¹Ù„ÙŠÙ…ÙŠØ© â€” Ù„Ø§ ØªØ¹ØªÙ…Ø¯ Ø¹Ù„ÙŠÙ‡Ø§ ÙˆØ­Ø¯Ù‡Ø§ Ù„Ù„ØªØ¯Ø§ÙˆÙ„ Ø§Ù„ÙØ¹Ù„ÙŠ.</div>
      </div>

      <div style="width:360px">
        <!-- ----- ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¯ÙØ¹ (Ù…Ø¨Ø§Ø´Ø± Ø¥Ù„Ù‰ Ø¥ÙŠÙ…ÙŠÙ„Ùƒ Ø¹Ø¨Ø± PayPal redirect) ----- -->
        <div class="box" style="margin-bottom:8px">
          <div class="muted">Ø§Ø¯Ø¹Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ â€” Ø§Ø´ØªØ±Ùƒ Ø¨Ù€ 0.10$ (Ø¯ÙˆÙ„Ø§Ø±) Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù…ÙŠØ²Ø§Øª Pro</div>

          <!-- PAYPAL REDIRECT FORM (classic) -->
          <form class="payform" action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_blank" style="margin-top:10px">
            <!-- required fields for 'Buy Now' -->
            <input type="hidden" name="cmd" value="_xclick">
            <!-- YOUR PayPal email -->
            <input type="hidden" name="business" value="mohamedgabershalan@gmail.com">
            <input type="hidden" name="item_name" value="SmartRisk Pro - 0.10 USD">
            <input type="hidden" name="amount" value="0.10">
            <input type="hidden" name="currency_code" value="USD">
            <!-- optional: custom field to pass e.g. username -->
            <input type="hidden" name="custom" value="smart_risk_pro_purchase">
            <input type="submit" value="Ø§Ø¯ÙØ¹ 0.10$ Ø¹Ø¨Ø± PayPal">
          </form>

          <div style="margin-top:8px" class="muted">Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… PayPal.me (Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ Ø±Ø§Ø¨Ø·):</div>
          <a class="paylink" href="https://www.paypal.me/mohamedgabershalan/0.10" target="_blank" rel="noopener noreferrer">Ø§Ø¯ÙØ¹ 0.10$ Ø¹Ø¨Ø± PayPal.me</a>

          <div style="margin-top:8px" class="muted">Ù…Ù„Ø§Ø­Ø¸Ø©: Ù‡Ø°Ø§ Ø­Ù„ Ù…Ø¨Ø§Ø´Ø± â€” Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù†Ø­ØªØ§Ø¬ Ø®Ø·ÙˆØ© ØªØ­Ù‚Ù‚ Ø®Ø§Ø¯Ù… (Ø³Ø£Ø²ÙˆØ¯Ùƒ Ø¨Ù‡Ø§ Ø¹Ù†Ø¯ Ø§Ù„Ø·Ù„Ø¨).</div>
        </div>
        <!-- ---------------------------------------------------------------- -->

        <div class="box" style="margin-bottom:8px">
          <div class="muted">Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„ (USD)</div>
          <input id="capital" type="number" value="2000" style="width:100%;margin-top:6px" />
          <div class="muted" style="margin-top:8px">Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø®Ø§Ø·Ø±Ø© Ø§Ù„Ù‚ØµÙˆÙ‰ Ù„Ù„ØµÙÙ‚Ø© (%)</div>
          <input id="riskPercent" type="number" value="1" style="width:100%;margin-top:6px" />
        </div>

        <div class="box" style="margin-bottom:8px">
          <div class="muted">Ø§Ù„Ù…Ø®Ø±Ø¬Ø§Øª</div>
          <div style="margin-top:8px">Ø­Ø¬Ù… Ù…ÙˆØµÙ‰ Ø¨Ù‡: <strong id="positionSize">â€”</strong> USD</div>
          <div style="margin-top:6px" id="kellyExpl" class="muted">â€”</div>
        </div>

        <div class="box" style="margin-bottom:8px">
          <div class="muted">Ø£ÙˆØ²Ø§Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ (Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„)</div>
          <div style="margin-top:6px">EMA: <input id="wEma" type="number" value="25" style="width:60px" />%</div>
          <div style="margin-top:6px">RSI: <input id="wRsi" type="number" value="18" style="width:60px" />%</div>
          <div style="margin-top:6px">MACD: <input id="wMacd" type="number" value="18" style="width:60px" />%</div>
          <div style="margin-top:6px">Volatility: <input id="wVol" type="number" value="15" style="width:60px" />%</div>
          <div style="margin-top:6px">Momentum: <input id="wMom" type="number" value="12" style="width:60px" />%</div>
          <div style="margin-top:6px">News Sentiment: <input id="wNews" type="number" value="12" style="width:60px" />%</div>
        </div>

        <div class="box" id="calendarBox" style="margin-bottom:8px">
          <div class="muted">Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠ (Ø£Ø­Ø¯Ø§Ø« Ù‚Ø§Ø¯Ù…Ø©)</div>
          <div id="calendarList" style="max-height:180px;overflow:auto;margin-top:8px">Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«...</div>
        </div>

        <div class="box">
          <div class="muted">Ø£Ø®Ø¨Ø§Ø± & Ù…Ø¹Ù†ÙˆÙŠØ§Øª (Ø¢Ø®Ø± Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†)</div>
          <div id="newsList" style="max-height:220px;overflow:auto;margin-top:8px">Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø®Ø¨Ø§Ø±...</div>
        </div>

      </div>
    </div>
  </div>

<script>
/* ===================== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø© ===================== */
const POLL_MS = 8000;
const MAX_POINTS = 500;
const STORAGE_KEY = 'smartrisk_full_v1';
let intervalId = null;

/* ===================== Ù…Ø¤Ø´Ø±Ø§Øª ÙÙ†ÙŠØ© (Ù…Ø¨Ø§Ø´Ø±Ø©) ===================== */
function ema(arr, period) {
  if (!arr.length) return null;
  const k = 2/(period+1);
  let prev = arr[0];
  for (let i=1;i<arr.length;i++){
    prev = arr[i]*k + prev*(1-k);
  }
  return prev;
}
function rsi(values, period=14) {
  if (values.length <= period) return null;
  let gains=0, losses=0;
  for (let i=values.length-period; i<values.length; i++){
    const d = values[i] - values[i-1];
    if (d>0) gains+=d; else losses+=Math.abs(d);
  }
  if (losses===0) return 100;
  const rs = (gains/period)/(losses/period);
  return 100 - (100/(1+rs));
}
function macd(values, fast=12, slow=26, signal=9){
  if (values.length < slow+signal) return null;
  const macdArr = [];
  for (let i=slow;i<values.length;i++){
    const sub = values.slice(0,i+1);
    const f = ema(sub,fast);
    const s = ema(sub,slow);
    if (f==null||s==null) continue;
    macdArr.push(f-s);
  }
  if (macdArr.length < signal) return null;
  const sig = ema(macdArr.slice(- (signal+1)), signal);
  return { macd: macdArr[macdArr.length-1], signal: sig };
}
function stddev(arr){
  if (!arr.length) return 0;
  const mean = arr.reduce((a,b)=>a+b,0)/arr.length;
  const v = arr.reduce((a,b)=>a+Math.pow(b-mean,2),0)/arr.length;
  return Math.sqrt(v);
}

/* ===================== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ===================== */
function loadSeries(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'); }catch(e){return []} }
function saveSeries(s){ localStorage.setItem(STORAGE_KEY, JSON.stringify(s.slice(-MAX_POINTS))); }

/* ===================== Ø§Ù„Ø±Ø³Ù… (Chart.js) ===================== */
const ctx = document.getElementById('chart').getContext('2d');
let chart = new Chart(ctx, {
  type:'line',
  data:{ labels:[], datasets:[
    { label:'Ø§Ù„Ø³Ø¹Ø±', data:[], borderColor:'#6ee7b7', borderWidth:2, tension:0.25, pointRadius:0 },
    { label:'EMA9', data:[], borderColor:'#93c5fd', borderWidth:1.5, tension:0.2, pointRadius:0 },
    { label:'EMA21', data:[], borderColor:'#fda4af', borderWidth:1.5, tension:0.2, pointRadius:0 }
  ]},
  options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{labels:{color:'#cfe6ff'}}}, scales:{x:{display:false}, y:{grid:{color:'rgba(255,255,255,0.04)'}}}}
});

/* ===================== Ø¬Ù„Ø¨ Ø£Ø³Ø¹Ø§Ø± (exchangerate.host) ===================== */
async function fetchLatest(pair){
  try{
    const [base,quote] = pair.split('/');
    const url = `https://api.exchangerate.host/latest?base=${encodeURIComponent(base)}&symbols=${encodeURIComponent(quote)}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const j = await res.json();
    return { price: j.rates[quote], raw:j };
  } catch(e){ console.error('fetch price err', e); return null; }
}

/* ===================== Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠ ===================== */
async function fetchEconomicCalendar() {
  try {
    const url = 'https://cdn-nfs.faireconomy.media/ff_calendar_thisweek.json';
    const res = await fetch(url);
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const j = await res.json();
    return j || [];
  } catch (e) {
    console.warn('calendar fetch fail', e);
    return null;
  }
}

/* ===================== Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø®Ø¨Ø§Ø± + ØªØ­ÙˆÙŠÙ„ RSS->JSON ===================== */
async function fetchNewsForPair(pair) {
  try {
    const q = encodeURIComponent(pair.replace('/',' '));
    const rss = `https://news.google.com/rss/search?q=${q}&hl=en-US&gl=US&ceid=US:en`;
    const api = `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(rss)}`;
    const res = await fetch(api);
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const j = await res.json();
    return j.items || [];
  } catch (e) {
    console.warn('news fetch fail', e);
    return null;
  }
}

/* ===================== ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø¹Ù†ÙˆÙŠØ§Øª (Ø¨Ø³ÙŠØ·) ===================== */
const POS_WORDS = ['gain','rise','rally','surge','bull','positive','beats','better','up','strong','improve','advances','record'];
const NEG_WORDS = ['fall','drop','slump','decline','weak','miss','worse','down','bear','cut','loss','risks','plunge'];

function sentimentScore(text) {
  if (!text) return 0;
  const t = text.toLowerCase();
  let score=0;
  POS_WORDS.forEach(w => { if (t.includes(w)) score += 1; });
  NEG_WORDS.forEach(w => { if (t.includes(w)) score -= 1; });
  const norm = Math.max(-1, Math.min(1, score / 3));
  return norm;
}

/* ===================== Ø¬Ù…Ø¹ Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª Ø¥Ù„Ù‰ Ø§Ø­ØªÙ…Ø§Ù„ ===================== */
function computeScore(series, newsSentimentValue, calendarImpactFactor=1) {
  const prices = series.map(s=>s.price);
  const n = prices.length;
  if (n < 30) return {score:null,signal:'HOLD',reason:'Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ù‚Ù„ Ù…Ù† 30 Ù†Ù‚Ø·Ø©'};

  const ema9Arr = [], ema21Arr = [];
  for (let i=0;i<prices.length;i++){
    const sub = prices.slice(0,i+1);
    ema9Arr.push(ema(sub,9) ?? null);
    ema21Arr.push(ema(sub,21) ?? null);
  }
  const latestE9 = ema9Arr[ema9Arr.length-1];
  const prevE9 = ema9Arr[ema9Arr.length-2];
  const latestE21 = ema21Arr[ema21Arr.length-1];
  const prevE21 = ema21Arr[ema21Arr.length-2];
  const crossUp = prevE9<=prevE21 && latestE9>latestE21;
  const crossDown = prevE9>=prevE21 && latestE9<latestE21;
  let emaSignal = 0;
  if (crossUp) emaSignal = 1;
  else if (crossDown) emaSignal = -1;
  else if (latestE9 && latestE21) emaSignal = Math.sign(latestE9 - latestE21);

  const rsiVal = rsi(prices,14);
  let rsiSignal = 0;
  if (rsiVal != null) {
    if (rsiVal < 30) rsiSignal = -0.8;
    else if (rsiVal < 40) rsiSignal = -0.3;
    else if (rsiVal <= 60) rsiSignal = 0;
    else if (rsiVal <= 70) rsiSignal = 0.3;
    else rsiSignal = 0.8;
  }

  const macdVal = macd(prices,12,26,9);
  let macdSignal = 0;
  if (macdVal) macdSignal = Math.sign(macdVal.macd - macdVal.signal);

  const vol = stddev(prices.slice(-30));
  const histVol = stddev(prices.slice(-100)) || vol || 1;
  const volSignal = Math.max(-1, Math.min(1, (1 - vol / histVol)));

  const momentum = prices[prices.length-1] - prices[Math.max(0, prices.length-5)];
  const momSignal = Math.max(-1, Math.min(1, momentum / (Math.abs(prices[prices.length-1]) || 1) * 50));

  const newsSignal = typeof newsSentimentValue === 'number' ? Math.max(-1, Math.min(1, newsSentimentValue)) : 0;

  const wEma = Number(document.getElementById('wEma').value)||25;
  const wRsi = Number(document.getElementById('wRsi').value)||18;
  const wMacd = Number(document.getElementById('wMacd').value)||18;
  const wVol = Number(document.getElementById('wVol').value)||15;
  const wMom = Number(document.getElementById('wMom').value)||12;
  const wNews = Number(document.getElementById('wNews').value)||12;

  const totalWeight = wEma + wRsi + wMacd + wVol + wMom + wNews;

  const parts = [
    {name:'EMA', w:wEma, v:(emaSignal+1)/2},
    {name:'RSI', w:wRsi, v:(rsiSignal+1)/2},
    {name:'MACD', w:wMacd, v:(macdSignal+1)/2},
    {name:'Vol', w:wVol, v:(volSignal+1)/2},
    {name:'Mom', w:wMom, v:(momSignal+1)/2},
    {name:'News', w:wNews, v:(newsSignal+1)/2}
  ];
  let raw=0;
  parts.forEach(p=> raw += p.w * p.v );
  let scorePct = Math.round((raw / totalWeight) * 100);

  scorePct = Math.round(scorePct * calendarImpactFactor);

  let signal = 'HOLD';
  if (scorePct >= 62) signal = 'BUY';
  else if (scorePct <= 38) signal = 'SELL';

  const reason = `EMA:${emaSignal>0?'â†‘':emaSignal<0?'â†“':'='} RSI:${rsiVal? rsiVal.toFixed(1):'n/a'} MACD:${macdVal? (macdVal.macd>macdVal.signal? 'â†‘':'â†“'):'n/a'} News:${newsSignal>=0? 'pos':'neg'}`;
  return { score: scorePct, signal, parts, reason, metrics:{rsiVal, vol, momentum, macdVal} };
}

/* ===================== Ø§Ù‚ØªØ±Ø§Ø­ Ø§Ù„Ø­Ø¬Ù… (Kelly-lite) ===================== */
function proposeSize(probPct){
  const capital = Number(document.getElementById('capital').value) || 1000;
  const riskPercent = Number(document.getElementById('riskPercent').value) || 1;
  const p = probPct/100;
  const winLoss = 1.5;
  let edge = p - (1-p)/winLoss;
  let kelly = edge / winLoss;
  if (kelly < 0) kelly = 0;
  kelly = kelly * 0.25;
  const maxAllowed = (riskPercent/100) * capital;
  const suggested = Math.min(kelly * capital, maxAllowed);
  return { suggested: Number(suggested.toFixed(2)), kellyPct: (kelly*100).toFixed(3), maxAllowed };
}

/* ===================== Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠ ===================== */
function renderCalendar(events){
  const el = document.getElementById('calendarList');
  if (!events) { el.innerHTML = '<div class="muted">ØªØ¹Ø°Ø± Ø¬Ù„Ø¨ Ø§Ù„ØªÙ‚ÙˆÙŠÙ….</div>'; return; }
  try {
    let list = Array.isArray(events) ? events : (events.events || events);
    if (!Array.isArray(list)) list = [];
    const now = Date.now();
    const upcoming = [];
    for (const it of list) {
      const impact = Number(it.impact) || 0;
      let eventTime = it.date ? (new Date(it.date).getTime()) : null;
      if (!eventTime && it.timestamp) eventTime = Number(it.timestamp)*1000;
      if (!eventTime || eventTime < now - 1000*60*60*24) continue;
      upcoming.push({title: it.title || it.event, currency: it.currency || it.symbol, impact: impact, time: eventTime});
    }
    upcoming.sort((a,b)=> a.time - b.time);
    const top = upcoming.slice(0,10);
    if (!top.length) el.innerHTML = '<div class="muted">Ù„Ø§ Ø£Ø­Ø¯Ø§Ø« Ù…Ù‡Ù…Ø© Ù‚Ø§Ø¯Ù…Ø©.</div>';
    else {
      el.innerHTML = top.map(ev => {
        const d = new Date(ev.time);
        const impactClass = ev.impact>=3 ? 'impactHigh' : ev.impact==2 ? 'impactMed' : 'impactLow';
        return `<div style="padding:6px 0;border-bottom:1px dashed rgba(255,255,255,0.03)"><div><strong>${ev.currency||''}</strong> â€” ${ev.title}</div><small>${d.toLocaleString()}</small> <div class="${impactClass}" style="float:right">${ev.impact>=3?'High':ev.impact==2?'Medium':'Low'}</div></div>`;
      }).join('');
    }
  } catch(e){
    el.innerHTML = '<div class="muted">Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªÙ‚ÙˆÙŠÙ….</div>';
  }
}

/* ===================== Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø®Ø¨Ø§Ø± ÙˆØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø¹Ù†ÙˆÙŠØ§Øª ===================== */
function renderNews(items) {
  const el = document.getElementById('newsList');
  if (!items) { el.innerHTML = '<div class="muted">ØªØ¹Ø°Ø± Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø®Ø¨Ø§Ø±.</div>'; return; }
  if (!items.length) { el.innerHTML = '<div class="muted">Ù„Ø§ Ø£Ø®Ø¨Ø§Ø± Ø­Ø¯ÙŠØ«Ø©.</div>'; return; }
  const top = items.slice(0,10);
  el.innerHTML = top.map(it => {
    const title = it.title || it.title_no_format || '';
    const s = sentimentScore(title);
    const color = s>0.2 ? 'ğŸŸ¢' : s<-0.2 ? 'ğŸ”´' : 'ğŸŸ¡';
    return `<div class="newsItem"><div>${color} <a href="${it.link}" target="_blank" style="color:#cfe6ff;text-decoration:none">${title}</a></div><small class="muted">${it.pubDate ? new Date(it.pubDate).toLocaleString() : ''}</small></div>`;
  }).join('');
  const avg = top.reduce((a,b)=> a + sentimentScore(b.title || ''), 0)/top.length;
  return avg;
}

/* ===================== Ø§Ù„Ø¯Ø§Ø±Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (tick) ===================== */
async function tick(pair) {
  document.getElementById('status').textContent = 'Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª...';
  const res = await fetchLatest(pair);
  if (!res) { document.getElementById('status').textContent = 'ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø¹Ø±'; return; }
  const series = loadSeries();
  series.push({t:Date.now(), price: res.price});
  saveSeries(series);

  if (!window._calendarCacheTime || Date.now() - window._calendarCacheTime > 60000) {
    window._calendarCache = await fetchEconomicCalendar();
    window._calendarCacheTime = Date.now();
    renderCalendar(window._calendarCache);
  }

  if (!window._newsCacheTime || Date.now() - window._newsCacheTime > 30000) {
    const newsItems = await fetchNewsForPair(pair);
    window._newsCache = newsItems;
    window._newsCacheTime = Date.now();
    const avgSent = renderNews(newsItems);
    window._newsSentiment = typeof avgSent === 'number' ? avgSent : 0;
  }

  let calendarImpactFactor = 1;
  try {
    const now = Date.now();
    const events = window._calendarCache || [];
    const list = Array.isArray(events) ? events : (events.events||events);
    if (Array.isArray(list)) {
      for (const ev of list) {
        const t = ev.date ? (new Date(ev.date).getTime()) : (ev.timestamp ? Number(ev.timestamp)*1000 : null);
        const impact = Number(ev.impact) || 0;
        if (t && impact >= 3 && t > now && t - now < 1000*60*60) {
          calendarImpactFactor = 0.6;
          break;
        }
        if (t && impact === 2 && t > now && t - now < 1000*60*30) {
          calendarImpactFactor = Math.min(calendarImpactFactor, 0.8);
        }
      }
    }
  } catch(e){ calendarImpactFactor = 1; }

  const newsSent = window._newsSentiment || 0;
  const computed = computeScore(series, newsSent, calendarImpactFactor);

  document.getElementById('lastPrice').textContent = res.price.toFixed(6);
  document.getElementById('prob').textContent = computed.score !== null ? computed.score : 'n/a';
  const sEl = document.getElementById('signal');
  sEl.className = 'signal ' + (computed.signal==='BUY'?'buy':computed.signal==='SELL'?'sell':'hold');
  sEl.textContent = computed.signal;
  document.getElementById('status').textContent = computed.reason;

  chart.data.labels = series.map(s=> new Date(s.t).toLocaleTimeString());
  const prices = series.map(s=>s.price);
  const ema9Arr = [], ema21Arr = [];
  for (let i=0;i<prices.length;i++){
    const sub = prices.slice(0,i+1);
    ema9Arr.push(ema(sub,9) ?? null);
    ema21Arr.push(ema(sub,21) ?? null);
  }
  chart.data.datasets[0].data = prices;
  chart.data.datasets[1].data = ema9Arr;
  chart.data.datasets[2].data = ema21Arr;
  chart.update();

  const pos = proposeSize(computed.score || 0);
  document.getElementById('positionSize').textContent = pos.suggested + ' USD';
  document.getElementById('kellyExpl').textContent = `Kelly-lite:${pos.kellyPct}% â€¢ Ø­Ø¯ Ù…Ø®Ø§Ø·Ø±:${pos.maxAllowed} USD â€¢ NewsAvg:${newsSent.toFixed(2)} â€¢ CalFactor:${calendarImpactFactor}`;

}

/* ===================== Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… ===================== */
document.getElementById('startBtn').addEventListener('click', async ()=>{
  const pair = document.getElementById('pair').value;
  document.getElementById('startBtn').disabled = true;
  document.getElementById('stopBtn').disabled = false;
  localStorage.removeItem(STORAGE_KEY);
  await tick(pair);
  intervalId = setInterval(()=> tick(pair), POLL_MS);
});
document.getElementById('stopBtn').addEventListener('click', ()=>{
  if (intervalId) clearInterval(intervalId);
  intervalId = null;
  document.getElementById('startBtn').disabled = false;
  document.getElementById('stopBtn').disabled = true;
});

/* ===================== init display ===================== */
(function init(){
  const existing = loadSeries();
  if (existing.length){
    chart.data.labels = existing.map(s => new Date(s.t).toLocaleTimeString());
    const prices = existing.map(s=>s.price);
    const ema9Arr = [], ema21Arr = [];
    for (let i=0;i<prices.length;i++){
      const sub = prices.slice(0,i+1);
      ema9Arr.push(ema(sub,9) ?? null);
      ema21Arr.push(ema(sub,21) ?? null);
    }
    chart.data.datasets[0].data = prices;
    chart.data.datasets[1].data = ema9Arr;
    chart.data.datasets[2].data = ema21Arr;
    chart.update();
  }
  (async ()=> {
    const cal = await fetchEconomicCalendar();
    window._calendarCache = cal; window._calendarCacheTime = Date.now();
    renderCalendar(cal);
    const news = await fetchNewsForPair(document.getElementById('pair').value);
    window._newsCache = news; window._newsCacheTime = Date.now();
    window._newsSentiment = renderNews(news);
  })();
})();
</script>

</body>
</html>

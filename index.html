<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ForexPulse — مراقب فوركس (Live, GitHub Pages)</title>
  <meta name="description" content="ForexPulse - مراقب فوركس حي للبحث عن نقاط دخول/خروج مبنية على EMA/RSI/MACD. بيانات حقيقية من Frankfurter API." />
  <!-- Chart.js from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    body{font-family:system-ui,Segoe UI,Arial; background:#071120; color:#e6eef8; margin:0; padding:18px}
    .card{background:#0b1220;border-radius:12px;padding:14px;margin-bottom:12px;box-shadow:0 8px 24px rgba(2,6,23,0.6)}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between}
    select,input,button{padding:8px 10px;border-radius:8px;border:1px solid #233244;background:#071126;color:#e6eef8}
    #chartWrapper{height:320px}
    .signal{font-weight:700;padding:6px 10px;border-radius:8px;display:inline-block}
    .buy{background:#063b13;color:#a7f3d0;border:1px solid #0b7a3a}
    .sell{background:#4b0505;color:#ffd7d7;border:1px solid #7a1212}
    .hold{background:#2b2f3a;color:#cbd5e1;border:1px solid #3b4250}
    small{color:#98a0b3}
    footer{font-size:13px;color:#98a0b3;margin-top:10px}
  </style>
</head>
<body>
  <div class="card">
    <header>
      <div>
        <h1 style="margin:0">ForexPulse — مراقب فوركس (Live)</h1>
        <small>مصدر البيانات: Frankfurter (public API) • تعمل مباشرة على GitHub Pages.</small>
      </div>
      <div>
        <label>زوج:
          <select id="pair">
            <option>EUR/USD</option>
            <option>GBP/USD</option>
            <option>USD/JPY</option>
            <option>USD/EGP</option>
            <option>AUD/USD</option>
          </select>
        </label>
        <button id="startBtn">ابدأ</button>
        <button id="stopBtn" disabled>أوقف</button>
      </div>
    </header>
  </div>

  <div class="card">
    <div style="display:flex;gap:12px;align-items:center;">
      <div>آخر سعر: <span id="lastPrice">—</span></div>
      <div>إشارة الآن: <span id="signal" class="signal hold">HOLD</span></div>
      <div id="details" style="margin-left:auto;color:#9fb0d6;font-size:13px"></div>
    </div>

    <div id="chartWrapper" class="mt-2">
      <canvas id="chart"></canvas>
    </div>

    <div style="margin-top:8px;">
      <small>ملاحظة مهمة: هذه أداة تحليل تقني بسيط (EMA/RSI/MACD) للأغراض التعليمية — لا تعتمد عليها وحدها لاتخاذ صفقات حقيقية.</small>
    </div>
  </div>

  <footer>
    <div>حفظ البيانات محليًا في المتصفح (localStorage). التحديث الافتراضي كل 10 ثواني (يمكن تغييره في الكود).</div>
    <div style="margin-top:6px">مرجع API: Frankfurter — free open-source currency API (client-side friendly). :contentReference[oaicite:1]{index=1}</div>
  </footer>

<script>
/* ====== إعدادات ====== */
const POLL_INTERVAL_MS = 10000; // تحديث كل 10s
const MAX_POINTS = 300;
const STORAGE_KEY = 'forexpulse_live_v2';

/* ====== مؤشرات فنية (وظائف) ====== */
function sma(arr, period) {
  if (arr.length < period) return null;
  const s = arr.slice(-period).reduce((a,b)=>a+b,0);
  return s/period;
}
function ema(arr, period) {
  if (!arr.length) return null;
  const k = 2/(period+1);
  let prev = arr[0];
  for (let i=1;i<arr.length;i++){
    prev = arr[i]*k + prev*(1-k);
  }
  return prev;
}
function rsi(values, period=14) {
  if (values.length <= period) return null;
  let gains = 0, losses = 0;
  for (let i = values.length - period; i < values.length; i++){
    const d = values[i] - values[i-1];
    if (d>0) gains += d; else losses += Math.abs(d);
  }
  if (losses===0) return 100;
  const rs = (gains/period)/(losses/period);
  return 100 - (100/(1+rs));
}
function macd(values, fast=12, slow=26, signal=9) {
  if (values.length < slow+signal) return null;
  const macdLineArr = [];
  for (let i=slow; i<values.length; i++){
    const sub = values.slice(0,i+1);
    const fastE = ema(sub, fast);
    const slowE = ema(sub, slow);
    if (fastE==null || slowE==null) continue;
    macdLineArr.push(fastE - slowE);
  }
  if (macdLineArr.length < signal) return null;
  const signalVal = ema(macdLineArr.slice(- (signal+1) ), signal);
  return { macd: macdLineArr[macdLineArr.length-1], signal: signalVal };
}

/* ====== إدارة البيانات (localStorage) ====== */
function loadSeries(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); } catch(e){return []} }
function saveSeries(s){ localStorage.setItem(STORAGE_KEY, JSON.stringify(s.slice(-MAX_POINTS))); }

/* ====== Chart.js إعداد ====== */
const ctx = document.getElementById('chart').getContext('2d');
let chart = new Chart(ctx, {
  type: 'line',
  data: {
    labels: [],
    datasets: [
      { label:'سعر', data: [], borderColor:'#6ee7b7', borderWidth:2, tension:0.25, pointRadius:0 },
      { label:'EMA9', data: [], borderColor:'#93c5fd', borderWidth:1.5, tension:0.2, pointRadius:0 },
      { label:'EMA21', data: [], borderColor:'#fda4af', borderWidth:1.5, tension:0.2, pointRadius:0 }
    ]
  },
  options: {
    responsive:true,
    maintainAspectRatio:false,
    scales: {
      x: { display:false },
      y: { grid:{color:'rgba(255,255,255,0.04)'} }
    },
    plugins: { legend:{labels:{color:'#cfe6ff'}} }
  }
});

/* ====== جلب السعر من Frankfurter (client-side friendly) ======
   API مثال: https://api.frankfurter.app/latest?from=USD&to=EUR
   (Frankfurter يعمل بدون مفتاح ويمكن استخدامه في المتصفح). */
async function fetchPair(pair) {
  try {
    const [base, quote] = pair.split('/');
    const url = `https://api.frankfurter.app/latest?from=${encodeURIComponent(base)}&to=${encodeURIComponent(quote)}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const j = await res.json();
    // النتيجة: j.rates[quote] قيمة 1 base = X quote
    return { price: j.rates[quote], raw: j };
  } catch(err){
    console.error('fetch error', err);
    return null;
  }
}

/* ====== منطق إشارة التداول ====== */
function computeIndicators(series) {
  const prices = series.map(p=>p.price);
  const ema9Arr = [], ema21Arr = [];
  for (let i=0;i<prices.length;i++){
    const sub = prices.slice(0,i+1);
    ema9Arr.push( ema(sub,9) ?? null );
    ema21Arr.push( ema(sub,21) ?? null );
  }
  return {
    prices,
    ema9Arr,
    ema21Arr,
    rsiVal: rsi(prices,14),
    macdVal: macd(prices,12,26,9)
  };
}

function decideSignal(series, ind) {
  const n = series.length;
  if (n < 30) return { signal:'HOLD', reason:'يحتاج بيانات أكثر (>=30 نقطة)' };
  const e9 = ind.ema9Arr, e21 = ind.ema21Arr;
  const last = n-1, prev = n-2;
  if (e9[prev]==null || e21[prev]==null || e9[last]==null || e21[last]==null) return { signal:'HOLD', reason:'EMA غير متوفرة' };
  const crossUp = e9[prev] <= e21[prev] && e9[last] > e21[last];
  const crossDown = e9[prev] >= e21[prev] && e9[last] < e21[last];
  const rsiVal = ind.rsiVal ?? 50;
  const macd = ind.macdVal;
  if (crossUp && rsiVal > 35 && rsiVal < 85 && macd && macd.macd > macd.signal) return { signal:'BUY', reason:`EMA صعودي • RSI=${rsiVal.toFixed(1)} • MACD موافق` };
  if (crossDown && rsiVal < 65 && rsiVal > 15 && macd && macd.macd < macd.signal) return { signal:'SELL', reason:`EMA هبوطي • RSI=${rsiVal.toFixed(1)} • MACD موافق` };
  return { signal:'HOLD', reason:`لا اتفاق بين المؤشرات • RSI=${ind.rsiVal?ind.rsiVal.toFixed(1):'n/a'}` };
}

/* ====== حلقة التشغيل ====== */
let intervalId = null;
async function tick(pair) {
  const res = await fetchPair(pair);
  if (!res) return;
  let series = loadSeries();
  series.push({t: Date.now(), price: res.price});
  series = series.slice(-MAX_POINTS);
  saveSeries(series);

  const ind = computeIndicators(series);
  // تحديث الرسم
  chart.data.labels = series.map(s => new Date(s.t).toLocaleTimeString());
  chart.data.datasets[0].data = ind.prices;
  chart.data.datasets[1].data = ind.ema9Arr;
  chart.data.datasets[2].data = ind.ema21Arr;
  chart.update();

  // إشارة
  const out = decideSignal(series, ind);
  const sEl = document.getElementById('signal');
  sEl.className = 'signal ' + (out.signal==='BUY'?'buy': out.signal==='SELL'?'sell':'hold');
  sEl.textContent = out.signal;
  document.getElementById('lastPrice').textContent = res.price.toFixed(6);
  document.getElementById('details').textContent = out.reason;
}

/* ====== واجهة المستخدم ====== */
document.getElementById('startBtn').addEventListener('click', async () => {
  const pair = document.getElementById('pair').value;
  document.getElementById('startBtn').disabled = true;
  document.getElementById('stopBtn').disabled = false;
  // تفريغ/تهيئة سلسلة جديدة عند تغيير الزوج
  localStorage.removeItem(STORAGE_KEY);
  // جلب فوري ثم interval
  await tick(pair);
  intervalId = setInterval(()=> tick(pair), POLL_INTERVAL_MS);
});
document.getElementById('stopBtn').addEventListener('click', ()=>{
  if (intervalId) { clearInterval(intervalId); intervalId = null; }
  document.getElementById('startBtn').disabled = false;
  document.getElementById('stopBtn').disabled = true;
});
/* عند تحميل الصفحة نزّل أي بيانات سابقة وارسم (إن وجدت) */
(function init(){
  const existing = loadSeries();
  if (existing.length){
    const ind = computeIndicators(existing);
    chart.data.labels = existing.map(s => new Date(s.t).toLocaleTimeString());
    chart.data.datasets[0].data = ind.prices;
    chart.data.datasets[1].data = ind.ema9Arr;
    chart.data.datasets[2].data = ind.ema21Arr;
    chart.update();
  }
})();
</script>
</body>
</html>
